name: Deploy Nuxt SSR to Production

on:
  push:
    branches:
      - production
  workflow_dispatch:  # Allow manual triggers

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # GitHub environment protection

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        continue-on-error: false  # Stop if tests fail

      - name: Build Nuxt SSR app for production
        run: npm run build
        env:
          NODE_ENV: production
          NUXT_PUBLIC_API_BASE: https://unikorn.axfff.com/api

      - name: Upload .output via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          source: ".output/"
          target: "/data/prod_unikorn/front-end/"
          # Add backup of previous version
          script_before: |
            if [ -d "/data/prod_unikorn/front-end/.output" ]; then
              mv /data/prod_unikorn/front-end/.output /data/prod_unikorn/front-end/.output.backup.$(date +%Y%m%d_%H%M%S)
            fi

      - name: Deploy and restart production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          script: |
            # Ensure NVM is loaded
            export NVM_DIR="$HOME/.nvm"
            source "$NVM_DIR/nvm.sh"
            nvm use 20
            
            # Verify deployment
            if [ ! -f "/data/prod_unikorn/front-end/.output/server/index.mjs" ]; then
              echo "Deployment verification failed!"
              exit 1
            fi
            
            # Graceful restart with zero downtime
            pm2 reload prod-unikorn-frontend --update-env
            
            # Health check
            sleep 5
            curl -f http://localhost:3000/health || exit 1
